{% extends "base.html" %}
{% load static %}
{% load competicio_extras %}

{% block title %}Inscripcions{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
  <style>
    .grouping-controls {
      background: #f7f8fb;
      border: 1px solid #e3e6ef;
      border-radius: 12px;
      padding: 12px 14px;
    }
    .grouping-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px 10px;
      align-items: center;
    }
    .group-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border: 1px solid #cfd6e6;
      border-radius: 999px;
      background: #ffffff;
      box-shadow: 0 1px 1px rgba(0, 0, 0, 0.03);
      cursor: pointer;
      user-select: none;
    }
    .group-chip input {
      margin: 0;
    }
    .grouping-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }
        /* Files dagrupaci贸 */
    tr.group-row {
        background-color: #f2f4f7;
        border-top: 2px solid #cbd5e1;
    }

    tr.group-row td {
        padding: 10px 12px;
        font-weight: 600;
        color: #1f2937;
    }

    /* Diferenciar nivells */
    tr.group-categoria {
        background-color: #e0f2fe;   /* blau suau */
    }

    tr.group-subcategoria {
        background-color: #ecfeff;   /* blau molt clar */
    }

        /* Files de grup: forcem color encara que hi hagi table-striped */
    tr.group-row > td {
      background-color: #e0f2fe !important; /* blau suau */
      border-top: 2px solid #94a3b8;
      border-bottom: 1px solid #cbd5e1;
      font-weight: 600;
    }

    /* Si vols diferenciar nivells */
    tr.group-g1 > td { background-color: #dbeafe !important; }  /* categoria */
    tr.group-g2 > td { background-color: #e0f2fe !important; }  /* subcategoria */
    tr.group-g3 > td { background-color: #ecfeff !important; }  /* tercer nivell */

    /* Afegim una classe per ocultar headers */
    .hidden-header {
      display: none;
    }

    /* Placeholder tab shown where a header was hidden */
    tr.hidden-placeholder > td {
      padding: 0 !important;
      background: transparent !important;
      border-top: none !important;
      border-bottom: none !important;
      height: 22px !important;
      line-height: 22px !important;
      vertical-align: middle !important;
    }

    .hidden-tab {
      display: inline-block;
      padding: 0 6px;
      height: 18px;
      line-height: 18px;
      border-radius: 6px;
      background: #fff8f0;
      border: 1px solid #f4d3b0;
      color: #7c2d12;
      font-size: 0.65rem;
      font-weight: 600;
      cursor: pointer;
      box-shadow: none;
    }

    /* Bot贸 molt petit per accions de cap莽alera */
    .btn-tiny {
      font-size: 0.65rem;
      padding: 0.18rem 0.4rem;
      line-height: 1;
      border-radius: 6px;
    }

  </style>

  <div class="card-surface">

    <!-- Control discret per reapar猫ixer headers ocults -->
    <!-- CAPALERA -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h2 class="mb-0">Inscripcions</h2>
        <div class="text-muted small">
          Competici贸: <span class="fw-semibold">{{ competicio.nom }}</span>
        </div>
      </div>

      <div class="d-flex gap-2 align-items-center">
        <a href="{% url 'import' competicio.id %}" class="btn btn-success">
          + Importar Excel
        </a>
      </div>
      <div class="d-flex gap-2 align-items-center">
        <a href="{% url 'inscripcio_add' competicio.id %}?next={{ request.get_full_path|urlencode }}" class="btn btn-primary">
          + Afegir inscripci贸
        </a>
      </div>
      <div class="d-flex gap-2">
        <a href="{% url 'created' %}" class="btn btn-info">
          Tornar a competicions
        </a>
      </div>
    </div>

    <!-- FILTRES + AGRUPACI -->
    <form method="get" class="mb-3">

      <!-- mantenim filtres actius -->
      <input type="hidden" name="q" value="{{ request.GET.q|default:'' }}">
      <input type="hidden" name="categoria" value="{{ request.GET.categoria|default:'' }}">
      <input type="hidden" name="subcategoria" value="{{ request.GET.subcategoria|default:'' }}">
      <input type="hidden" name="entitat" value="{{ request.GET.entitat|default:'' }}">
      <input type="hidden" name="per_page" value="{{ request.GET.per_page|default:'10' }}">

      <div class="grouping-controls grouping-chips">
        
        <span class="fw-semibold small text-muted">Agrupa per:</span>

        {% for f in allowed_group_fields %}
          <label class="group-chip small mb-0">
            <input type="checkbox"
                   name="group_by"
                   value="{{ f }}"
                   {% if f in selected_group_fields %}checked{% endif %}>
            {{ f|capfirst }}
          </label>
        {% endfor %}

        <div class="grouping-actions">
        
        <button type="submit" name="recalc_order" value="1" class="btn btn-sm btn-outline-primary">
          Aplicar agrupaci贸
        </button>

        <button type="submit" name="shuffle_order" value="1" class="btn btn-sm btn-outline-warning">
          Barreja aleat貌riament
        </button>


        {% if selected_group_fields %}
          <a class="btn btn-sm btn-outline-secondary"
            href="?clear_group=1&q={{ request.GET.q|urlencode }}&categoria={{ request.GET.categoria|urlencode }}&subcategoria={{ request.GET.subcategoria|urlencode }}&entitat={{ request.GET.entitat|urlencode }}">
            Treure agrupaci贸
          </a>

        {% endif %}
        </div>
        <button class="btn btn-sm btn-outline-warning"
                name="undo"
                value="1"
                {% if not request.session.inscripcions_undo_state %}disabled{% endif %}>
          Tirar enrere
        </button>

        <span style="font-weight: 300px;">Grups: </span>
        <select name="group_mode" class="form-select form-select-sm" style="width:170px">
          {% with gm=request.GET.group_mode|default:"fixed" %}
            <option value="fixed" {% if gm == "fixed" %}selected{% endif %}>Mida fixa</option>
            <option value="balanced" {% if gm == "balanced" %}selected{% endif %}>Grups equilibrats</option>
          {% endwith %}
        </select>
        Mida dels grups:
        <input type="number" name="group_size" min="2" max="50"
                      value="{{ request.GET.group_size|default:8 }}"
                      class="form-control form-control-sm" style="width:90px"
                      placeholder="Mida">
        <button type="submit" name="make_groups" value="1" class="btn btn-sm btn-outline-dark">
          Crear grups
        </button>


        <div class="d-flex gap-2 align-items-center">
          <select name="sort_key" class="form-select form-select-sm" style="width: 210px;">
            {% with sk=request.GET.sort_key|default:"nom" %}
              <option value="nom" {% if sk == "nom" %}selected{% endif %}>Nom (A-Z)</option>
              <option value="edat" {% if sk == "edat" %}selected{% endif %}>Edat / Data naixement</option>
              <option value="entitat" {% if sk == "entitat" %}selected{% endif %}>Entitat</option>
              <option value="categoria" {% if sk == "categoria" %}selected{% endif %}>Categoria</option>
              <option value="subcategoria" {% if sk == "subcategoria" %}selected{% endif %}>Subcategoria</option>
              <option value="sexe" {% if sk == "sexe" %}selected{% endif %}>Sexe</option>
              <option value="document" {% if sk == "document" %}selected{% endif %}>Document</option>
            {% endwith %}
          </select>

          <select name="sort_dir" class="form-select form-select-sm" style="width: 110px;">
            {% with sd=request.GET.sort_dir|default:"asc" %}
              <option value="asc" {% if sd == "asc" %}selected{% endif %}>Asc</option>
              <option value="desc" {% if sd == "desc" %}selected{% endif %}>Desc</option>
              <option value="arrow_asc" {% if sd == "arrow_asc" %}selected{% endif %}>Fletxa (asc)</option>
              <option value="arrow_desc" {% if sd == "arrow_desc" %}selected{% endif %}>Fletxa (desc)</option>
            {% endwith %}
          </select>

          <button class="btn btn-sm btn-outline-secondary" name="sort_within_groups" value="1">
            Ordena dins grups
          </button>
        </div>


        <button type="submit" name="clear_groups" value="1" class="btn btn-sm btn-outline-secondary">
          Esborrar grups
        </button>
      </div>
      <div class="d-flex gap-2 align-items-center flex-wrap mt-2">
        <div class="small text-muted">T铆tol de grup:</div>

        {% for key in allowed_group_fields %}
          <label class="form-check form-check-inline m-0">
            <input class="form-check-input"
                  type="checkbox"
                  name="title_fields"
                  value="{{ key }}"
                  {% if key in title_fields_selected %}checked{% endif %}>
            <span class="form-check-label">{{ key|capfirst }}</span>
          </label>
        {% endfor %}

        <button class="btn btn-sm btn-outline-success" name="export_excel" value="1">
          Exportar Excel
        </button>
      </div>

    </form>

    <!-- TAULA -->
    <div class="table-responsive">
      <table class="table table-striped table-bordered table-sm align-middle">
        <thead class="table-light">
          <tr>
            <th>Nom i cognoms</th>
            <th>DNI</th>
            <th>Sexe</th>
            <th>Data naixement</th>
            <th>Entitat</th>
            <th>Categoria</th>
            <th>Subcategoria</th>
            <th>Grup</th>
            <th>Ordre</th>
            <th>Accions</th>

          </tr>
        </thead>

        {% with g1=selected_group_fields.0 g2=selected_group_fields.1 g3=selected_group_fields.2 %}
        <tbody id="sortable-body" data-agrupant="{% if selected_group_fields %}1{% else %}0{% endif %}">

          {% for r in records %}

            {# HEADER GRUP 1 #}
            {% if g1 %}
              {% ifchanged r|attr:g1 %}
                <tr id="header-g1-{{ forloop.counter }}"
                    data-label="{{ r|attr_default:g1|default:'(Sense valor)' }}"
                    class="group-row group-g1">
                  <td colspan="10" class="ps-2">
                      <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center gap-2">
                          <span class="fw-semibold">{{ g1|capfirst }}:</span>
                          <span class="me-2">{{ r|attr_default:g1|default:"(Sense valor)" }}</span>
                          <button type="button"
                                  class="btn btn-sm btn-outline-dark js-independent-group"
                                  data-lvl="g1"
                                  data-v1="{% if r|attr_default:g1 %}{{ r|attr_default:g1 }}{% else %}__NULL__{% endif %}">
                            Fer grup independent
                          </button>

                        </div>

                        <div>
                          <button class="btn btn-sm btn-outline-secondary"
                                  onclick="event.stopPropagation(); toggleHeader('header-g1-{{ forloop.counter }}')">
                            Oculta
                          </button>
                        </div>
                      </div>
                  </td>
                </tr>
              {% endifchanged %}
            {% endif %}

            {# HEADER GRUP 2 (opcional) #}
            {% if g2 %}
              {% ifchanged r|attr:g2 %}
                <tr id="header-g2-{{ forloop.counter }}"
                    data-label="{{ r|attr_default:g2|default:'(Sense valor)' }}"
                    class="group-row group-g2">
                  <td colspan="10" class="ps-3">
                      <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center gap-2">
                          <span class="fw-semibold">{{ g2|capfirst }}:</span>
                          <span class="me-2">{{ r|attr_default:g2|default:"(Sense valor)" }}</span>
                          <button type="button"
                                  class="btn btn-sm btn-outline-dark js-independent-group"
                                  data-lvl="g2"
                                  data-v1="{% if r|attr_default:g1 %}{{ r|attr_default:g1 }}{% else %}__NULL__{% endif %}"
                                  data-v2="{% if r|attr_default:g2 %}{{ r|attr_default:g2 }}{% else %}__NULL__{% endif %}">
                            Fer grup independent
                          </button>
                        </div>

                        <div>
                          <button class="btn btn-sm btn-outline-secondary"
                                  onclick="event.stopPropagation(); toggleHeader('header-g2-{{ forloop.counter }}')">
                            Oculta
                          </button>
                        </div>
                      </div>
                  </td>
                </tr>
              {% endifchanged %}
            {% endif %}

            {# HEADER GRUP 3 (opcional) #}
            {% if g3 %}
              {% ifchanged r|attr:g3 %}
                <tr id="header-g3-{{ forloop.counter }}"
                    data-label="{{ r|attr_default:g3|default:'(Sense valor)' }}"
                    class="group-row group-g3">
                  <td colspan="10" class="ps-4">
                      <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center gap-2">
                          <span class="fw-semibold">{{ g3|capfirst }}:</span>
                          <span class="me-2">{{ r|attr_default:g3|default:"(Sense valor)" }}</span>
                          <button type="button"
                                  class="btn btn-sm btn-outline-dark js-independent-group"
                                  data-lvl="g3"
                                  data-v1="{% if r|attr_default:g1 %}{{ r|attr_default:g1 }}{% else %}__NULL__{% endif %}"
                                  data-v2="{% if r|attr_default:g2 %}{{ r|attr_default:g2 }}{% else %}__NULL__{% endif %}"
                                  data-v3="{% if r|attr_default:g3 %}{{ r|attr_default:g3 }}{% else %}__NULL__{% endif %}">
                            Fer grup independent
                          </button>
                        </div>

                        <div>
                          <button class="btn btn-sm btn-outline-secondary"
                                  onclick="event.stopPropagation(); toggleHeader('header-g3-{{ forloop.counter }}')">
                            Oculta
                          </button>
                        </div>
                      </div>
                  </td>
                </tr>
              {% endifchanged %}
            {% endif %}


            <!-- FILA INSCRIPCI -->
            <tr class="inscripcio-row" data-id="{{ r.id }}">
              <td class="fw-bold">{{ r.nom_i_cognoms|default:"-" }}</td>
              <td>{{ r.document|default:"-" }}</td>
              <td>{{ r.sexe|default:"-" }}</td>
              <td>
                {% if r.data_naixement %}
                  {{ r.data_naixement|date:"d/m/Y" }}
                {% else %}-{% endif %}
              </td>
              <td>{{ r.entitat|default:"-" }}</td>
              <td>{{ r.categoria|default:"-" }}</td>
              <td>{{ r.subcategoria|default:"-" }}</td>
              <td>{{ r.grup|default:"-" }}</td>
              <td>{{ r.ordre_sortida|default:"-" }}</td>
              <td class="text-nowrap">
                <a class="btn btn-sm btn-outline-primary"
                  href="{% url 'inscripcio_edit' competicio.id r.id %}?next={{ request.get_full_path|urlencode }}">
                  Editar
                </a>

                <a class="btn btn-sm btn-outline-danger"
                  href="{% url 'inscripcio_delete' competicio.id r.id %}?next={{ request.get_full_path|urlencode }}">
                  Eliminar
                </a>
              </td>

            </tr>

          {% empty %}
            <tr>
              <td colspan="9" class="text-center text-muted">
                No hi ha inscripcions per aquesta competici贸
              </td>
            </tr>
          {% endfor %}
        </tbody>
        {% endwith %}
      </table>
    </div>

  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>

<script>
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  const tbody = document.getElementById('sortable-body');

  function isHeaderRow(tr) {
    return tr && tr.classList.contains('group-row');
  }

  function headerLevel(tr) {
    if (!tr) return null;
    if (tr.classList.contains('group-g1')) return 'g1';
    if (tr.classList.contains('group-g2')) return 'g2';
    if (tr.classList.contains('group-g3')) return 'g3';
    return null;
  }

  // Bloc = header + tot fins abans del seg眉ent header del mateix nivell
  function getHeaderBlockRows(headerTr) {
    const lvl = headerLevel(headerTr);
    const rows = [headerTr];

    let cur = headerTr.nextElementSibling;
    while (cur) {
      if (isHeaderRow(cur) && lvl && cur.classList.contains('group-' + lvl)) break;
      rows.push(cur);
      cur = cur.nextElementSibling;
    }
    return rows;
  }
  let movedId = null;
  let newIndex = null;

  async function saveOrder() {
    const ids = Array.from(tbody.querySelectorAll('tr.inscripcio-row'))
      .map(tr => tr.dataset.id);

    const resp = await fetch("{% url 'inscripcions_reorder' competicio.id %}", {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify({ ids, moved_id: movedId, new_index: newIndex })
    });

    if (!resp.ok) {
      const txt = await resp.text();
      console.error("Error desant ordre:", resp.status, txt);
      alert(`No s'ha pogut desar l'ordre (${resp.status}).\n${txt}`);
      return false;
    }
    return true;
  }

  if (tbody) {
    let draggedBlockRest = null; // guardarem les files del bloc (excloent header) mentre arrosseguem

    new Sortable(tbody, {
      animation: 150,

      // IMPORTANT: ara permetem arrossegar tamb茅 headers
      draggable: 'tr.group-row, tr.inscripcio-row',

      // Evita que clicar botons (Oculta, etc.) inici茂 drag
      filter: 'button, .hidden-tab',
      preventOnFilter: true,

      onStart: function (evt) {
        const item = evt.item;

        // Si arrosseguem un header, capturem el bloc abans que Sortable el mogui
        if (isHeaderRow(item)) {
          const block = getHeaderBlockRows(item);
          draggedBlockRest = block.slice(1); // tot menys el header
        } else {
          draggedBlockRest = null;
        }
      },

      onEnd: async function (evt) {
        const item = evt.item;

        // Si s'ha arrossegat un header: movem la resta del bloc just darrere del header
        if (isHeaderRow(item) && draggedBlockRest && draggedBlockRest.length) {
          // 1) treu la resta del bloc de l'antic lloc (encara hi 茅s)
          draggedBlockRest.forEach(r => r.parentNode && r.parentNode.removeChild(r));

          // 2) inserta-la immediatament despr茅s del header, mantenint ordre
          const frag = document.createDocumentFragment();
          draggedBlockRest.forEach(r => frag.appendChild(r));
          item.parentNode.insertBefore(frag, item.nextElementSibling);

          draggedBlockRest = null;
        }

        // Determina quin registre s'ha mogut i el seu nou 铆ndex (0-based) dins les inscripcions
        if (item && item.classList.contains('inscripcio-row')) {
          movedId = item.dataset.id;

          const insRows = Array.from(tbody.querySelectorAll('tr.inscripcio-row'));
          newIndex = insRows.findIndex(tr => tr.dataset.id === movedId);
        } else {
          // Si s'ha arrossegat un header, NO volem canviar grups
          movedId = null;
          newIndex = null;
        }


        // 3) Desa l'ordre final (nom茅s inscripcions)
        const ok = await saveOrder();
        if (ok) window.location.reload();
      }
    });
  }


  // Funci贸 per ocultar o mostrar headers
  function toggleHeaders() {
    const headers = Array.from(document.querySelectorAll('tr.group-row'));
    headers.forEach(header => {
      // use per-row toggle to keep placeholder/tab behaviour
      toggleHeader(header.id);
    });
  }

  // Funci贸 per ocultar o mostrar un header espec铆fic
  function toggleHeader(headerId) {
    const header = document.getElementById(headerId);
    if (!header) return;

    // si ja tenim l'original guardada -> restore
    if (header.dataset.orig) {
      // restaurar contingut
      header.innerHTML = header.dataset.orig;
      header.classList.remove('hidden-placeholder');
      delete header.dataset.orig;
      updateHiddenHeadersControl(headerId, false);
      return;
    }

    // amagar: guardar original i mostrar una pestanya compacta
    header.dataset.orig = header.innerHTML;
    const label = header.getAttribute('data-label') || headerId;
    header.classList.add('hidden-placeholder');
    header.innerHTML = `<td colspan="9" class="p-0"><div style="display:flex;align-items:center;padding:0 6px;height:22px;"><div class=\"hidden-tab\" onclick=\"toggleHeader('${headerId}')\"></div></div></td>`;
    updateHiddenHeadersControl(headerId, true);
  }

  // Mant茅 llista d'headers ocults i mostra control discreta
  function updateHiddenHeadersControl(headerId, hidden) {
    const control = document.getElementById('hidden-headers-control');
    const list = document.getElementById('hidden-headers-list');
    if (!control || !list) return;

    if (hidden) {
      // afegir a la llista (evitar duplicats)
      if (!document.getElementById('hidden-item-' + headerId)) {
        const header = document.getElementById(headerId);
        const label = header ? header.getAttribute('data-label') || headerId : headerId;
        const item = document.createElement('div');
        item.className = 'list-group-item d-flex justify-content-between align-items-center';
        item.id = 'hidden-item-' + headerId;
        item.innerHTML = `<span>${label}</span><button class="btn btn-sm btn-link">Mostra</button>`;
        item.querySelector('button').addEventListener('click', () => {
          // restaurar utilitzant la mateixa funci贸 (toggleHeader)
          toggleHeader(headerId);
          item.remove();
          if (!list.children.length) control.style.display = 'none';
        });
        list.appendChild(item);
        control.style.display = 'block';
      }
    } else {
      // eliminar de la llista
      const item = document.getElementById('hidden-item-' + headerId);
      if (item) item.remove();
      if (!list.children.length) control.style.display = 'none';
    }
  }
  function saveScroll() {
  sessionStorage.setItem("scrollY", String(window.scrollY || 0));
}

function restoreScroll() {
  const y = sessionStorage.getItem("scrollY");
  if (y !== null) window.scrollTo(0, parseInt(y, 10));
  sessionStorage.removeItem("scrollY");
}

// restaura scroll quan recarreguem despr茅s d'una acci贸
window.addEventListener("load", restoreScroll);

async function makeIndependentGroupFromButton(btn) {
  const params = new URLSearchParams(window.location.search);

  params.set("make_independent_group", "1");
  params.set("lvl", btn.dataset.lvl || "g1");
  params.set("v1", btn.dataset.v1 || "");
  if (btn.dataset.v2 !== undefined) params.set("v2", btn.dataset.v2);
  if (btn.dataset.v3 !== undefined) params.set("v3", btn.dataset.v3);

  // guardem posici贸 abans de recarregar
  saveScroll();

  const url = `${window.location.pathname}?${params.toString()}`;

  const resp = await fetch(url, {
    method: "GET",
    headers: {
      "X-Requested-With": "XMLHttpRequest"
    }
  });

  if (!resp.ok) {
    const txt = await resp.text();
    console.error("Error fer grup independent:", resp.status, txt);
    alert(`No s'ha pogut fer el grup independent (${resp.status}).\n${txt}`);
    sessionStorage.removeItem("scrollY");
    return;
  }

  // refresquem per veure els canvis (per貌 tornarem al mateix scroll)
  window.location.reload();
}

// Delegaci贸 d'esdeveniments
document.addEventListener("click", (e) => {
  const btn = e.target.closest(".js-independent-group");
  if (!btn) return;
  e.preventDefault();
  makeIndependentGroupFromButton(btn);
});

</script>


{% endblock %}
