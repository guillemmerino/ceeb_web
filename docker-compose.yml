services:

  # ----------------------------------------------------------------------------------------------------------
  # WEB
  # ----------------------------------------------------------------------------------------------------------
  web:
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      - .:/app
      - ../db_provisional:/data/media
    ports:
      - "8000:8000"
    environment:
      CALENDARITZACIONS_URL: "http://calendaritzacions:8000"  # host dins la xarxa de Compose
      CERTIFICATS_API: "http://certificats:8000/process-pdfs/"
      CALENDARITZACIONS_API: "http://calendaritzacions:8000/process_async/"
      CALENDARITZACIONS_API_SEGONA_FASE: "http://calendaritzacions:8000/process_async_segona_fase/"
      DESIGNACIONS_API: "http://designacions:8000/process_designacions/"
      LLISTATS_PROVISIONALS_API: "http://natacio:8000/provisionals/"
      LLISTATS_DEFINITIUS_API: "http://natacio:8000/definitius/"
      CELERY_BROKER_URL: "redis://redis:6379/0"  # URL del backend de missatgeria
      RAG_URL: "http://rag:8000/chatbot/"
      DESIGNACIONS_URL: "http://designacions:8000"
      MEDIA_ROOT: /data/media
      MEDIA_URL: /media/
      # Database connection info for Django (must match the `db` service)
      POSTGRES_USER: ceeb_user
      POSTGRES_PASSWORD: ceeb_password
      POSTGRES_DB: ceeb_db
      POSTGRES_HOST: db
      POSTGRES_PORT: 5432
    depends_on:
      - redis
      - db
    command: ["python", "manage.py", "runserver", "0.0.0.0:8000"]

  # ----------------------------------------------------------------------------------------------------------
  # CALENDARIS
  # ----------------------------------------------------------------------------------------------------------


  calendaritzacions:
    build:
      context: ../calendaritzacions
      dockerfile: Dockerfile.dev
    volumes:
      - ../calendaritzacions:/app
      - ../db_provisional:/data/media
    environment:
      MEDIA_ROOT: /data/media

    expose:
      - "8000"  # només per a la xarxa interna; si vols provar des del navegador, afegeix ports: ["8001:8000"]
    command: ["uvicorn", "app:app", "--host", "0.0.0.0", "--port", "8000"]
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://calendaritzacions:8000/health"]
      interval: 5s
      timeout: 2s
      retries: 10


  # ----------------------------------------------------------------------------------------------------------
  # CERTIFICATS
  # ----------------------------------------------------------------------------------------------------------

  certificats:
    build:
      context: ../formacio
      dockerfile: Dockerfile.dev
    volumes:
      - ../formacio:/app
      - ../db_provisional:/data/media
    environment:
      MEDIA_ROOT: /data/media

    expose:
      - "8000"  # només per a la xarxa interna; si vols provar des del navegador, afegeix ports: ["8001:8000"]
    command: ["uvicorn", "app:app", "--host", "0.0.0.0", "--port", "8000"]
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://certificats:8000/health"]
      interval: 5s
      timeout: 2s
      retries: 10


  # ----------------------------------------------------------------------------------------------------------
  # NATACIO
  # ----------------------------------------------------------------------------------------------------------

  natacio:
    build: 
      context: ../natacio
      dockerfile: Dockerfile
    container_name: natacio
    
    volumes:
      - ../natacio:/app
      - ../db_provisional:/data/media/

    environment:
      MEDIA_ROOT: /data/media/
      MEDIA_URL: /media/
    expose:
      - "8000"
    command: ["uvicorn", "app:app", "--host", "0.0.0.0", "--port", "8000"]
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://natacio:8000/health"]
      interval: 5s
      timeout: 2s
      retries: 10


  # ----------------------------------------------------------------------------------------------------------
  # DESIGNACIONS
  # ----------------------------------------------------------------------------------------------------------

  designacions:
    build:
      context: ../designacions
      dockerfile: Dockerfile
    volumes:
      - ../designacions:/app
      - ../db_provisional:/data/media
    environment:
      MEDIA_ROOT: /data/media

    expose:
      - "8000"  # només per a la xarxa interna; si vols provar des del navegador, afegeix ports: ["8001:8000"]
    command: ["uvicorn", "app:app", "--host", "0.0.0.0", "--port", "8000"]
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://designacions:8000/health"]
      interval: 5s
      timeout: 2s
      retries: 10


  # ----------------------------------------------------------------------------------------------------------
  # OLLAMA I RAG
  # ----------------------------------------------------------------------------------------------------------

  ollama:
    image: ollama/ollama:latest
    restart: unless-stopped
    ports:
      - "11434:11434"
    volumes:
      - ollama_models:/root/.ollama
    healthcheck:
      test: ["CMD", "ollama", "list"]
      interval: 10s
      timeout: 5s
      start_period: 25s     # dona temps per arrencar
      retries: 10


  rag:
    build:
      context: ../RAG
      dockerfile: Dockerfile.api
    environment:
      - PERSIST_DIR=/app/vector_db
      - OLLAMA_HOST=http://ollama:11434     # <--- URL del servei, no 0.0.0.0
      - EMBED_MODEL=nomic-embed-text
    volumes:
      - ../RAG:/app
      - ../RAG/vector_db:/app/vector_db
    expose:
      - "8000"
    command: ["uvicorn", "src.api_server:app", "--host", "0.0.0.0", "--port", "8000"]
    depends_on:
      ollama:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://rag:8000/health"]
      interval: 5s
      timeout: 2s
      retries: 10


  # ----------------------------------------------------------------------------------------------------------
  # DATABASE
  # ----------------------------------------------------------------------------------------------------------
  db:
    image: postgres:15
    restart: unless-stopped
    container_name: db
    environment:
      POSTGRES_USER: ceeb_user
      POSTGRES_PASSWORD: ceeb_password
      POSTGRES_DB: ceeb_db
    volumes:
      - db_data:/var/lib/postgresql/data
    expose:
      - "5432" # només per a la xarxa interna
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ceeb_user -d ceeb_db"]
      interval: 5s
      timeout: 2s
      retries: 10



  # ----------------------------------------------------------------------------------------------------------
  # DEPURACIÓ, LOGS I TASQUES
  # ----------------------------------------------------------------------------------------------------------
  # Servei Redis com a backend de missatgeria per a Celery
  redis:
    image: redis:7  # Utilitza la imatge oficial de Redis
    container_name: redis
    ports:
      - "6379:6379"  # Exposa el port 6379 per a connexions locals
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 2s
      retries: 5

  # Worker per a tasques pesades (p. ex. processar certificats)
  worker-heavy:
    build:
      context: .
      dockerfile: Dockerfile
    command: celery -A ceeb_web worker -l info -Q heavy_queue -c 4 --hostname=worker-heavy@%h
    depends_on:
      - redis
    environment:
      CELERY_BROKER_URL: "redis://redis:6379/0"
      MEDIA_ROOT: /data/media
      MEDIA_URL: /media/
      # DB env for tasks that run in workers
      POSTGRES_USER: ceeb_user
      POSTGRES_PASSWORD: ceeb_password
      POSTGRES_DB: ceeb_db
      POSTGRES_HOST: db
      POSTGRES_PORT: 5432
    volumes:
      - .:/app
      - ../db_provisional:/data/media

  # Worker per a tasques lleugeres (emails, neteges, etc.)
  worker-default:
    build:
      context: .
      dockerfile: Dockerfile
    command: celery -A ceeb_web worker -l info -Q default -c 2 --hostname=worker-default@%h
    depends_on:
      - redis
    environment:
      CELERY_BROKER_URL: "redis://redis:6379/0"
      MEDIA_ROOT: /data/media
      MEDIA_URL: /media/
      POSTGRES_USER: ceeb_user
      POSTGRES_PASSWORD: ceeb_password
      POSTGRES_DB: ceeb_db
      POSTGRES_HOST: db
      POSTGRES_PORT: 5432
    volumes:
      - .:/app
      - ../db_provisional:/data/media

volumes:
  ollama_models:  # Volum persistent per models Ollama
  db_data:       # Volum persistent per la base de dades PostgreSQL