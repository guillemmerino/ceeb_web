{% extends 'base.html' %}
{% load static %}

{% block title %}Llistats Provisionals{% endblock %}

{% block content %}
<section class="upload_section layout_padding">
  <div class="container">
    <h2>Llistats Provisionals</h2>
    <p>Adjunta un fitxer `.xlsx` per processar-lo.</p>

    <div id="status-message" class="alert" style="display: none;"></div>

    <form id="provisionals-form" action="{% url 'llistats_provisionals' %}" method="post" enctype="multipart/form-data">
      {% csrf_token %}
      <div class="form-group mb-3">
        <label for="fileInput" class="form-label">Selecciona un arxiu (.xlsx):</label>
        <input type="file" id="fileInput" name="file" class="form-control" accept=".xlsx" required>
      </div>
      <button type="submit" class="btn btn-primary">Pujar i processar</button>
    </form>

    <div id="progress-section" style="display: none;">
      <h3>Estat del procés</h3>
      <p id="progress-status">Iniciant...</p>
      <!-- Spinner shown while remote processing is ongoing -->
      <div id="loading-spinner" style="display:none; margin:10px 0;">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
      </div>
      <ul id="progress-logs"></ul>
      <div id="download" class="mt-3"></div>
    </div>
  </div>
</section>

<script>
  const MEDIA_URL = "{{ MEDIA_URL }}";
  const form = document.getElementById('provisionals-form');
  const progressSection = document.getElementById('progress-section');
  const statusMessage = document.getElementById('progress-status');
  const logsList = document.getElementById('progress-logs');
  const downloadDiv = document.getElementById('download');

  let es = null; // EventSource
  let lastProgress = 0;

  form.addEventListener('submit', function (e) {
    e.preventDefault();

    const formData = new FormData(this);
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    fetch("{% url 'llistats_provisionals' %}", {
      method: 'POST',
      headers: { 'X-CSRFToken': csrfToken },
      body: formData,
    })
    .then(r => r.json())
    .then(data => {
      if (data.task_id) {
        form.style.display = 'none';
        progressSection.style.display = 'block';
        statusMessage.textContent = 'Iniciant...';
        startLogStream(data.task_id);
        checkTaskStatus(data.task_id);
      } else if (data.error) {
        alert(data.error);
      } else {
        alert('Error en iniciar el procés.');
      }
    })
    .catch(console.error);
  });

  function startLogStream(taskId) {
    if (es) es.close();
    es = new EventSource(`/logs/${taskId}/stream`);

    // show spinner when logs start streaming
    const spinner = document.getElementById('loading-spinner');
    if (spinner) spinner.style.display = 'block';

    es.onmessage = (e) => {
      try {
        const payload = JSON.parse(e.data); // {message, progress?}
        if (payload.message) appendLog(payload.message);
        if (typeof payload.progress === 'number') {
          lastProgress = payload.progress;
          statusMessage.textContent = `Progrés: ${payload.progress}%`;
        }
      } catch (err) {
        appendLog(e.data);
      }
    };

    es.onerror = () => {
      // EventSource reintenta automàticament.
    };
  }

  function appendLog(text) {
    const li = document.createElement('li');
    li.textContent = text;
    logsList.appendChild(li);
    logsList.parentElement.scrollTop = logsList.parentElement.scrollHeight;
  }

  function checkTaskStatus(taskId) {
    fetch(`/task-status/${taskId}/`)
      .then(response => response.json())
      .then(data => {
        if (data.status === 'SUCCESS') {
          statusMessage.textContent = 'Procés completat!';
          // hide spinner when done
          const spinner = document.getElementById('loading-spinner');
          if (spinner) spinner.style.display = 'none';
          if (es) es.close();
          // Prefer explicit result_url from the status response, otherwise
          // construct the URL from MEDIA_URL + predictable filename.
          let downloadHref = null;
          if (data.result_url) downloadHref = data.result_url;
          else if (data.result) downloadHref = data.result; // may be relative
          else {
            // fallback: predictable filename using task id
            downloadHref = `${MEDIA_URL}llistats_provisionals/${taskId}_result.xlsx`;
          }
          const a = document.createElement('a');
          a.href = downloadHref;
          a.textContent = 'Descarregar resultat';
          a.className = 'btn btn-success';
          downloadDiv.appendChild(a);
        } else if (data.status === 'FAILURE') {
          statusMessage.textContent = `Error: ${data.error || 'Error desconegut'}`;
          // hide spinner on failure
          const spinner = document.getElementById('loading-spinner');
          if (spinner) spinner.style.display = 'none';
          if (es) es.close();
        } else {
          statusMessage.textContent = lastProgress
            ? `Progrés: ${lastProgress}%`
            : `Estat: ${data.status}`;
          // ensure spinner is visible while waiting
          const spinner = document.getElementById('loading-spinner');
          if (spinner) spinner.style.display = 'block';
          setTimeout(() => checkTaskStatus(taskId), 2000);
        }
      })
      .catch(error => {
        appendLog(`Error consultant l'estat: ${error}`);
        setTimeout(() => checkTaskStatus(taskId), 4000);
      });
  }
</script>
{% endblock %}
