{% extends "base.html" %}

{% block title %}Seguiment alumnat{% endblock %}

{% block content %}
<div class="container-fluid mt-4">

  <div class="card-surface">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2>Seguiment alumnat</h2>

		<div class="header-controls">

		<!-- FILA 1: cerca bàsica -->
		<div class="d-flex align-items-center gap-2">
			<form method="get" class="d-flex gap-2 align-items-center">
			<input type="search" name="q" placeholder="Cerca per nom..."
					value="{{ request.GET.q|default:'' }}"
					class="form-control form-control-sm" />

			<select name="per_page" class="form-select form-select-sm">
				<option value="5" {% if request.GET.per_page == '5' %}selected{% endif %}>5</option>
				<option value="10" {% if request.GET.per_page == '10' or not request.GET.per_page %}selected{% endif %}>10</option>
				<option value="25" {% if request.GET.per_page == '25' %}selected{% endif %}>25</option>
				<option value="50" {% if request.GET.per_page == '50' %}selected{% endif %}>50</option>
			</select>

			<button type="submit" class="btn btn-sm btn-secondary">Aplica</button>
			</form>

			<button type="button"
					id="toggleAdvancedSearch"
					class="btn btn-sm btn-outline-info">
			Cerca avançada
			</button>

            <div class="d-flex flex-column">
              <a href="{% url 'seguiment_create' %}" class="btn btn-primary mb-2">
              + Afegir Alumne
              </a>

              <a href="{% url 'seguiment_import_excel' %}" class="btn btn-success">
              + Actualitzar Notes
              </a>
            </div>
		</div>

		<!-- FILA 2: cerca avançada -->
		<form method="get"
				id="advancedSearchForm"
				class="d-none gap-2 align-items-center mt-2">
			<select name="camp" class="form-select form-select-sm">
			<option value="document">DNI</option>
			<option value="correu">Correu</option>
			<option value="sexe">Sexe</option>
			<option value="estat">Estat</option>
			<option value="ropec">ROPEC</option>
			<option value="bc">BC</option>
			<option value="cj">CJ</option>
			<option value="cg">CG</option>
			<option value="pa">PA</option>
			<option value="mdp">MDP</option>
			</select>

			<input type="search"
				name="valor"
				placeholder="Valor..."
				class="form-control form-control-sm" />

			<button type="submit" class="btn btn-sm btn-info">
			Cercar
			</button>
		</form>

		</div>
      </div>

      {% if is_paginated %}
      <nav aria-label="Paginació" class="mt-3">
        <ul class="pagination justify-content-center mb-0">
          {% if page_obj.has_previous %}
            <li class="page-item">
              <a class="page-link" href="?page={{ page_obj.previous_page_number }}&per_page={{ request.GET.per_page|default:'10' }}&q={{ request.GET.q|urlencode }}">&laquo; Anterior</a>
            </li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">&laquo; Anterior</span></li>
          {% endif %}

          <li class="page-item disabled"><span class="page-link">Pàgina {{ page_obj.number }} de {{ paginator.num_pages }}</span></li>

          {% if page_obj.has_next %}
            <li class="page-item">
              <a class="page-link" href="?page={{ page_obj.next_page_number }}&per_page={{ request.GET.per_page|default:'10' }}&q={{ request.GET.q|urlencode }}">Següent &raquo;</a>
            </li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">Següent &raquo;</span></li>
          {% endif %}
        </ul>
      </nav>
      {% endif %}

    <div class="table-responsive">
    <table class="table table-striped table-bordered table-sm align-middle">
      <thead class="table-light">
        <tr>
          <th>Nom i cognoms</th>
          <th>DNI</th>
          <th>Correu</th>
          <th>Sexe</th>
          <th>Data naixement</th>
          <th>BC</th>
          <th>CJ</th>
          <th>CG</th>
          <th>PA</th>
          <th>MDP</th>
          <th>ROPEC</th>
          <th>Estat</th>
          <th>Accions</th>
        </tr>
      </thead>
      <tbody>
        {% for r in records %}
        <tr>
          <td><a href="{% url 'seguiment_update' r.id %}" class="text-decoration-none fw-bold">{{ r.nom_i_cognom|default:"-" }}</a></td>
          <td>{{ r.document|default:"-" }}</td>
          <td>{{ r.correu|default:"-" }}</td>
          <td>{{ r.sexe|default:"-" }}</td>
          <td>{% if r.data_naixement %}{{ r.data_naixement|date:"d/m/Y" }}{% else %}-{% endif %}</td>
          <td>{{ r.bc|default:"-" }}</td>
          <td>{{ r.cj|default:"-" }}</td>
          <td>{{ r.cg|default:"-" }}</td>
          <td>{{ r.pa|default:"-" }}</td>
          <td>{{ r.mdp|default:"-" }}</td>
          <td>{{ r.ropec|default:"-" }}</td>
          <td>{{ r.estat|default:"-" }}</td>
          <td>
            <a href="{% url 'seguiment_send_email' r.id %}"
               class="btn btn-sm btn-outline-secondary">
              Email
            </a>
            <a href="{% url 'seguiment_delete' r.id %}"
               class="btn btn-sm btn-danger ms-1">
              Eliminar
            </a>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="13" class="text-center text-muted">
            No hi ha registres
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    </div>
    <div class="text-center mt-3" id="loadMoreContainer">
      {% if is_paginated and page_obj.has_next %}
        <button id="loadMoreBtn" class="btn btn-outline-primary" data-next-page="{{ page_obj.next_page_number }}">Carrega més</button>
      {% endif %}
    </div>
  </div>

</div>
{% endblock %}
  {% block extra_scripts %}
  <script>
  (function(){
    const btn = document.getElementById('loadMoreBtn');
    if(!btn) return;
    btn.addEventListener('click', async function(){
      const next = btn.dataset.nextPage;
      const params = new URLSearchParams(window.location.search);
      const per_page = params.get('per_page') || '{{ request.GET.per_page|default:"10" }}';
      const q = params.get('q') || '';
      btn.disabled = true;
      btn.innerText = 'Carregant...';
      try {
        const url = `{% url 'seguiment_ajax' %}?page=${next}&per_page=${per_page}&q=${encodeURIComponent(q)}`;
        const resp = await fetch(url);
        if(!resp.ok) throw new Error('Network error');
        const data = await resp.json();
        const tbody = document.querySelector('table.table tbody');
        data.records.forEach(r=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
              <td><a href="${r.edit_url}" class="text-decoration-none fw-bold">${r.nom_i_cognom}</a></td>
              <td>${r.document}</td>
              <td>${r.correu}</td>
              <td>${r.sexe}</td>
              <td>${r.data_naixement}</td>
              <td>${r.bc}</td>
              <td>${r.cj}</td>
              <td>${r.cg}</td>
              <td>${r.pa}</td>
              <td>${r.mdp}</td>
              <td>${r.ropec}</td>
              <td>${r.estat}</td>
              <td>
                <a class="btn btn-sm btn-outline-secondary" href="${r.edit_url}">Editar</a>
                <a class="btn btn-sm btn-danger ms-1" href="/formacio/seguiment/${r.id}/eliminar/">Eliminar</a>
              </td>
            `;
          tbody.appendChild(tr);
        });
        if(data.has_next){
          btn.dataset.nextPage = data.next_page;
          btn.disabled = false;
          btn.innerText = 'Carrega més';
        } else {
          btn.remove();
        }
      } catch(err){
        console.error(err);
        btn.disabled = false;
        btn.innerText = 'Error, torna a intentar';
      }
    });
  })();
  </script>
<script>
  document.getElementById('toggleAdvancedSearch').addEventListener('click', function(){
    const form = document.getElementById('advancedSearchForm');

    if (form.classList.contains('d-none')) {
      form.classList.remove('d-none');
      form.classList.add('d-flex');
    } else {
      form.classList.remove('d-flex');
      form.classList.add('d-none');
    }
  });
</script>
  {% endblock %}
